<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskPu - College Q&A Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{url_for ('static',filename='css/styles.css')}}">

</head>
<body>
    <!-- Header -->
     <header>
        <div class="header-container">
            <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <a href="{{ url_for('index') }}" class="logo">
<img src="{{ url_for('static', filename='uploads/logo.png') }}" 
     alt="Logo" 
     style="height: 50px; width: auto; max-width: 100%; object-fit: contain;">
     <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600&display=swap" rel="stylesheet">
<span class="logo-text">AskPu</span>

            </a>

    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <form method="GET" action="{{ url_for('search') }}">
        <input type="text" class="search-bar" name="query" placeholder="Search questions, answers, topics...">
    </form>
    </div>



            <div class="nav-icons">
                <a href="{{url_for('ask')}}" class="nav-icon" id="ask-btn">
                    <i class="fas fa-plus-circle"></i>
                    <span>Ask</span>
                </a>
                <div class="nav-icon" id="notifications-btn">
                    <i class="fas fa-bell"></i>
                    <span>Notif</span>
                    
                </div>
                <div class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon toggle-icon" id="theme-icon"></i>
                    <span class="toggle-text">Dark Mode</span>
                </div>
   


  <img src="https://api.dicebear.com/6.x/avataaars/svg?seed=male" alt="Default Avatar">

                </a>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
           <a href="{{ url_for('index') }}" class="logo">
<img src="{{ url_for('static', filename='uploads/logo.png') }}" 
     alt="Logo" 
     style="height: 50px; width: auto; max-width: 100%; object-fit: contain;">
     <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600&display=swap" rel="stylesheet">
<span class="logo-text">AskPu</span>

            </a>
            <button class="close-mobile-menu" id="close-mobile-menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <a href="{{ url_for('login') }}" class="menu-item active-menu">
            <i class="fas fa-home"></i>
            <span>Home Feed</span>
        </a>
        <a href="{{url_for('login')}}" class="menu-item">
            <i class="fas fa-question-circle"></i>
            <span>Ask Question</span>
        </a>
        <a href="{{url_for('login')}}" class="menu-item">
            
            <span>My Profile</span>
        </a>
        <a href="{{url_for('login')}}" class="menu-item">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login</span>
        </a>
        
        <div class="sidebar-card" style="margin-top: 1.5rem;">
            <h3 class="sidebar-title">Top Departments</h3>
            <div class="tag-list">
                <div class="tag">Computer Science</div>
                <div class="tag">Electrical Engineering</div>
                <div class="tag">Mechanical</div>
                <div class="tag">Business Admin</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-card">
                <h3 class="sidebar-title">Menu</h3>
                <a href="{{ url_for('login') }}" class="menu-item active-menu">
                    <i class="fas fa-home"></i>
                    <span>Home Feed</span>
                </a>
                <a href="{{url_for('login')}}" class="menu-item">
                    <i class="fas fa-question-circle"></i>
                    <span>Ask Question</span>
                </a>
                <a href="{{url_for('login')}}" class="menu-item">
                    <i class="fas fa-user"></i>
                    <span>My Profile</span>
                </a>
                <a href="{{url_for('login')}}" class="menu-item">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </a>
            </div>
            
            <div class="sidebar-card">
                <h3 class="sidebar-title">Top Departments</h3>
<div class="tag-list">
    {% for dept in department_tags %}
    <div class="tag">{{ dept }}</div>
    {% endfor %}
</div>
            </div>
            
            <div class="sidebar-card">
                <h3 class="sidebar-title">Popular Tags</h3>
<div class="tag-list">
    {% for tag in top_tags %}
    <div class="tag">#{{ tag }}</div>
    {% endfor %}
</div>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="custom-flash alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
        <!-- Main Content Area -->

 
        <div class="main-content">
{% for question in questions %}
            <!-- Question 1 -->
            <div class="content-card slide-in">
                <div class="card-header">
                    <div class="user-info">
                        {% if question.author.image %}
  <img src="{{ url_for('static', filename='uploads/' + question.author.image) }}" alt="Avatar">
{% else %}
  <img src="https://api.dicebear.com/6.x/avataaars/svg?seed={{ question.author.username }}" alt="Default Avatar">
{% endif %}
                        <div class="user-details">
                            <div class="user-name">{{ question.author.full_name }}</div>
                            <div class="user-meta">{{question.author.department}} · {{question.author.year}} yr · {{ question.created_at|time_ago }}</div>
                        </div>
                    </div>
                </div>
                
                <h2 class="question-title">{{ question.title }}</h2>
                
                <div class="question-content">
                    {{ question.description|truncate(200) |safe }}
                </div>
                
                <div class="question-footer">
                    <div class="action-buttons">
                        <button class="action-button">
                            <i class="fas fa-comment"></i>
                            <span>{{question.answers|length}} Answers</span>
                        </button>
                        <button class="action-button">
                            <i class="fas fa-bookmark"></i>
                            <span>Save</span>
                        </button>
                        <button class="action-button">
                            <i class="fas fa-share"></i>
                            <span>Share</span>
                        </button>
                        <button class="action-button">
                            <i class="fas fa-flag"></i>
                            <span>Report</span>
                        </button>
                    </div>
                </div>
                <br>
                <br>
<h3 style="cursor: pointer; color: #3f51b5;" onclick="toggleAnswer('{{ question.id }}')">Answers:</h3>

<div id="answer-toggle-{{ question.id }}" style="display: none; transition: all 0.3s ease;">

  {% for answer in question.answers %}
  <div class="comments-section">
    <div class="comment">
      <div class="comment-avatar">{{ answer.author.first_name[0] }}{{ answer.author.last_name[0] }}</div>
      <div class="comment-content">
        <div class="comment-header">
          <div class="comment-author">{{ answer.author.username }}</div>
          <div class="comment-time">
            answered {{ answer.created_at.strftime('%b %d, %Y') }}
          </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; float: right; margin-left: 10px;">
          <button class="upvote-btn" onclick="handleVote('{{ answer.id }}', 'upvote')" style="border: none; background: none; color: green;">
            <h4>Upvote</h4>
          </button>
          <span class="vote-score" id="score-{{ answer.id }}">{{ answer.score }}</span>
          <button class="downvote-btn" onclick="handleVote('{{ answer.id }}', 'downvote')" style="border: none; background: none; color: gray;">
            <h5>Downvote</h5>
          </button>
        </div>

        <div class="comment-text">{{ answer.content | safe }}</div>

      </div>
    </div>
  </div>

  <!-- Comments toggle inside each answer -->
  <b style="cursor: pointer; color: #3f51b5;" onclick="toggleComments('{{ answer.id }}')">Comments:</b>
  <div id="comment-toggle-{{ answer.id }}" style="overflow: hidden; max-height: 0; opacity: 0; display: none; transition: max-height 0.4s ease, opacity 0.4s ease;">
    {% for comment in answer.comments %}
    <div class="coment-box">
      <div class="comment-text">
        <div class="comment-avatar">{{ answer.author.first_name[0] }}{{ answer.author.last_name[0] }}</div>
        <div><p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p></div>
        <small>{{ comment.created_at|time_ago }}</small>
      </div>
    </div>
    {% endfor %}

    <br>
    <hr>
  </div>
  {% endfor %}

</div>
</div>           
<!--              -->
            <!-- Answer Form -->

             {% endfor %}
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <div class="sidebar-card">
                <h3 class="sidebar-title">Your Profile</h3>
                <div class="user-info" style="margin-bottom: 1.5rem;">

  <img src="https://api.dicebear.com/6.x/avataaars/svg?seed=default" alt="Avatar">

                    <div class="user-details">
                        <div class="user-name"></div>
                        <div class="user-meta"></div>
                    </div>
                </div>
                <a href="{{url_for('login')}}" class="action-button" style="width: 100%; justify-content: center;">
                    <i class="fas fa-edit"></i>
                    <span>Edit Profile</span>
                </a>
            </div>
            
            <div class="sidebar-card">
                <h3 class="sidebar-title">Notifications</h3>
{% for note in notifications %}
<div class="notification-item {% if not note.is_read %}unread{% endif %}">
    <div class="user-info">
        <img src="https://api.dicebear.com/6.x/avataaars/svg?seed={{ note.sender.username }}" alt="Avatar" width="36" height="36">
        <div class="user-details">
            <div class="user-name">{{ note.sender.full_name }} {{ note.message }}</div>
            <div class="user-meta">{{ note.created_at|time_ago }}</div>
        </div>
    </div>
</div>
{% endfor %}
            </div>
            
            <div class="sidebar-card">
                <h3 class="sidebar-title">Moderation Tools</h3>
                <a href="#" class="menu-item">
                    <i class="fas fa-flag"></i>
                    <span>Reported Content</span>
                    <div class="notification-badge" style="position: static; margin-left: auto;">8</div>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-user-slash"></i>
                    <span>User Reports</span>
                    <div class="notification-badge" style="position: static; margin-left: auto;">3</div>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-ban"></i>
                    <span>Banned Users</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Moderation Stats</span>
                </a>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<!-- place this after all your answers are rendered -->
 <script>
function toggleAnswer(questionId) {
  const box = document.getElementById('answer-toggle-' + questionId);
  if (box.style.display === 'none' || box.style.display === '') {
    box.style.display = 'block';
  } else {
    box.style.display = 'none';
  }
}

function toggleComments(answerId) {
  const box = document.getElementById('comment-toggle-' + answerId);
  if (box.style.maxHeight && box.style.maxHeight !== '0px') {
    box.style.maxHeight = '0px';
    box.style.opacity = '0';
    setTimeout(() => { box.style.display = 'none'; }, 400);
  } else {
    box.style.display = 'block';
    requestAnimationFrame(() => {
      box.style.maxHeight = box.scrollHeight + 'px';
      box.style.opacity = '1';
    });
  }
}
</script>

<script>
    
document.addEventListener("DOMContentLoaded", function () {
    const editor = document.getElementById("editor");
    const hiddenInput = document.getElementById("hidden-content");

    // Toolbar buttons
    document.querySelectorAll(".tool-button").forEach(button => {
        button.addEventListener("click", function (e) {
            e.preventDefault();
            const command = this.title.toLowerCase();

            if (command === "image") {
                const url = prompt("Enter image URL");
                if (url) {
                    document.execCommand("insertImage", false, url);
                }
            } else if (command === "link") {
                const url = prompt("Enter URL");
                if (url) {
                    document.execCommand("createLink", false, url);
                }
            } else if (command === "code") {
                const code = prompt("Enter code snippet");
                if (code) {
                    document.execCommand("insertHTML", false, `<pre><code>${code}</code></pre>`);
                }
            } else {
                document.execCommand(command);
            }
        });
    });

    // Form submission – capture HTML from contenteditable
document.querySelector(".answer-form").addEventListener("submit", function () {
        hiddenInput.value = editor.innerHTML;
    });
});
    async function handleVote(answerId, voteType) {
        // Find both buttons for this answer
        const upvoteButton = document.querySelector(`.upvote-btn[data-answer-id='${answerId}']`);
        const downvoteButton = document.querySelector(`.downvote-btn[data-answer-id='${answerId}']`);

        // ✅ Disable both buttons to prevent double-clicks
        upvoteButton.disabled = true;
        downvoteButton.disabled = true;

        try {
            const response = await fetch(`/vote/${answerId}/${voteType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // If you use Flask-WTF CSRF, you'll need a header for the token
                }
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(`score-${answerId}`).innerText = data.score;
            } else {
                console.error('Failed to vote');
            }
        } catch (error) {
            console.error('Error during vote:', error);
        } finally {
            // ✅ Re-enable buttons after the request is complete
            upvoteButton.disabled = false;
            downvoteButton.disabled = false;
        }
    }
    </script>

</body>
</html>